<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>3</storyId>
    <title>Email Verification &amp; Account Activation</title>
    <status>drafted</status>
    <generatedAt>2025-11-28</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-3-email-verification-account-activation.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a new user</asA>
    <iWant>to verify my email address by clicking a link</iWant>
    <soThat>my account can be activated and I can log in.</soThat>
    <tasks>
- **Backend (API)**
  - [ ] Generate a unique, secure, and time-limited token for email verification. (AC: #1)
  - [ ] Create a tRPC procedure to handle the verification link click. (AC: #2)
  - [ ] Implement logic to validate the token and update the `User`'s `emailVerified` status in the database. (AC: #2)
  - [ ] Modify the login procedure to check the `emailVerified` status before authenticating the user. (AC: #4)
  - [ ] Add subtask for testing the verification and login procedures.
- [ ] **Frontend (UI)**
  - [ ] Create a page to handle the verification link, which shows a success or error message. (AC: #3)
  - [ ] Implement logic to display an "unverified account" message on the login page if an unverified user tries to log in. (AC: #4)
  - [ ] Add subtask for testing the verification page and login behavior for unverified users.
- [ ] **Email Template**
  - [ ] Design and implement an email template for the verification email using `react-email`. (AC: #1)
  - [ ] Ensure the template includes the unique verification link.
    </tasks>
  </story>

  <acceptanceCriteria>
1. Verification email contains a unique, time-limited link.
2. Clicking the link activates the user's account by updating the `emailVerified` field in the database.
3. User is redirected to a login page or a success message after verification.
4. Unverified accounts cannot log in.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR001: User &amp; Authentication</section>
        <snippet>Users must be able to authenticate using their school-provided email accounts via OAuth 2.0. (Implicitly covers email verification as part of the authentication flow).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>ADR 4: Email Service</section>
        <snippet>We will use Resend for sending all transactional emails.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 1.3: Email Verification &amp; Account Activation</section>
        <snippet>As a new user, I want to verify my email address by clicking a link, so that my account can be activated and I can log in.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>prisma/schema.prisma</path>
        <kind>schema</kind>
        <symbol>User, VerificationToken</symbol>
        <lines>Relevant lines for User model (emailVerified field already exists) and a new VerificationToken model.</lines>
        <reason>The User model's 'emailVerified' field needs to be managed. A new 'VerificationToken' model will be required to store and manage email verification tokens securely.</reason>
      </artifact>
      <artifact>
        <path>src/server/api/routers/auth.ts</path>
        <kind>api-router</kind>
        <symbol>verifyEmailProcedure</symbol>
        <lines>N/A (New procedure in existing/new auth router)</lines>
        <reason>A new tRPC procedure is needed to handle the verification link click, validate the token, and update the user's 'emailVerified' status.</reason>
      </artifact>
      <artifact>
        <path>src/app/auth/verify/page.tsx</path>
        <kind>ui-component</kind>
        <symbol>VerifyEmailPage</symbol>
        <lines>N/A (New file)</lines>
        <reason>A new page component needs to be created to display messages after email verification and handle the verification flow.</reason>
      </artifact>
      <artifact>
        <path>src/emails/VerificationEmail.tsx</path>
        <kind>email-template</kind>
        <symbol>VerificationEmail</symbol>
        <lines>N/A (New file)</lines>
        <reason>A new React component for the verification email template using 'react-email' needs to be created.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency ecosystem="node">
        <name>next</name>
        <version>^15.2.3</version>
        <reason>Core application framework.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>react</name>
        <version>^19.0.0</version>
        <reason>UI library for building components.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>next-auth</name>
        <version>5.0.0-beta.25</version>
        <reason>Authentication library for Next.js.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>@prisma/client</name>
        <version>^6.6.0</version>
        <reason>O/RM for database interaction.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>@trpc/server</name>
        <version>^11.0.0</version>
        <reason>Framework for creating type-safe APIs.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>zod</name>
        <version>^3.24.2</version>
        <reason>Schema validation library for tRPC inputs.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>react-email</name>
        <version>~0.0.0</version>
        <reason>Library for creating email templates using React components.</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Email verification tokens must be unique, secure, and time-limited, generated using a secure method like `crypto.randomBytes`.</constraint>
    <constraint>A hash of the verification token should be stored in the database for secure comparison.</constraint>
    <constraint>The NextAuth.js login procedure must be modified to prevent login for users with an unverified email address (`emailVerified: false`).</constraint>
    <constraint>The tRPC procedure for handling email verification must be a public procedure, not requiring prior authentication.</constraint>
    <constraint>The Resend service must be used for sending all verification emails.</constraint>
    <constraint>The verification page should be located at 'src/app/auth/verify/'.</constraint>
    <constraint>Email templates should be located in a new 'src/emails' directory and use 'react-email'.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>verifyEmail</name>
      <kind>tRPC-procedure</kind>
      <signature>
        verifyEmail: publicProcedure
          .input(z.object({
            token: z.string().uuid(), // Assuming UUID for token
          }))
          .mutation(async ({ ctx, input }) => {
            // Implementation to validate token and update user's emailVerified status
          });
      </signature>
      <path>src/server/api/routers/auth.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>
      A pragmatic testing approach will be used.
      - **Unit Tests:** Jest and React Testing Library will be used for unit testing critical UI components and business logic.
      - **Integration Tests:** Integration tests will be written for tRPC API procedures to ensure they interact with the database correctly.
    </standards>
    <locations>
      Test files should be co-located with the source files they are testing (e.g., `MyComponent.tsx` and `MyComponent.test.tsx` in the same folder).
    </locations>
    <ideas>
      <idea for="AC1">Write an integration test to verify that the Resend service sends a verification email containing a unique, time-limited link.</idea>
      <idea for="AC2">Write an integration test for the 'verifyEmail' tRPC procedure to ensure it correctly validates the token and updates the user's `emailVerified` status in the database. Include tests for valid, invalid, and expired tokens.</idea>
      <idea for="AC3">Write a unit/e2e test for the `/auth/verify` page to check for correct redirection or success/error message display after verification.</idea>
      <idea for="AC4">Modify existing login tests to ensure that unverified accounts cannot successfully log in.</idea>
    </ideas>
  </tests>
</story-context>
