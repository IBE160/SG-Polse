<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>4</storyId>
    <title>Document Management &amp; Versioning (Basic)</title>
    <status>drafted</status>
    <generatedAt>2025-11-28</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-4-document-management-versioning-basic.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a teacher</asA>
    <iWant>to view a list of documents I have uploaded for a course and manage them</iWant>
    <soThat>I can ensure the chatbot uses the correct and most up-to-date materials.</soThat>
    <tasks>
- [ ] **Backend (API)**
  - [ ] Create a tRPC procedure to list the documents in Supabase Storage for a given course. (AC: #1)
  - [ ] Create a tRPC procedure to delete a document from Supabase Storage. (AC: #2)
  - [ ] When a document is deleted, trigger an event to remove its embeddings from Pinecone.
- [ ] **Frontend (UI)**
  - [ ] On the content management page, display the list of uploaded documents. (AC: #1)
  - [ ] Add a "delete" button for each document. (AC: #2)
  - [ ] Implement a confirmation dialog before deleting a document.
  - [ ] The existing upload functionality should handle replacing documents with the same name. (AC: #3)
  - [ ] Add subtask for testing the document list and delete functionality.
    </tasks>
  </story>

  <acceptanceCriteria>
1. The teacher can see a list of all documents uploaded for a specific course.
2. The teacher can delete existing documents.
3. Uploading a new version of an existing document replaces the old version in the knowledge base.
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR010: Data &amp; Content Management</section>
        <snippet>The system must have a mechanism to ensure the chatbot is always working with the most up-to-date information from Canvas (relevant for document updates and deletions).</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR011: Data &amp; Content Management</section>
        <snippet>Teachers must be able to upload text documents and presentations for the chatbot to process (implies managing uploaded documents).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>File Storage</section>
        <snippet>All course documents are stored securely using Supabase Storage.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Integration Points</section>
        <snippet>Pinecone: A service client will be created to interact with the Pinecone vector database for indexing and querying.</snippet>
      </doc>
      <doc>
        <path>docs/ux-design-specification.md</path>
        <title>UX Design Specification</title>
        <section>User Journey 2: Teacher Updates Course Information</section>
        <snippet>Teacher manages uploaded course materials.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epics</title>
        <section>Story 3.4: Document Management &amp; Versioning (Basic)</section>
        <snippet>As a teacher, I want to view a list of documents I have uploaded for a course and manage them, so that I can ensure the chatbot uses the correct and most up-to-date materials.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/server/api/routers/teacher.ts</path>
        <kind>api-router</kind>
        <symbol>listDocumentsProcedure, deleteDocumentProcedure</symbol>
        <lines>N/A (New procedures in existing teacher router)</lines>
        <reason>New tRPC procedures are needed to list and delete documents uploaded by a teacher for a specific course.</reason>
      </artifact>
      <artifact>
        <path>src/app/teacher/course/[courseId]/page.tsx</path>
        <kind>page</kind>
        <symbol>CourseContentManagementPage</symbol>
        <lines>N/A (Modification to existing page)</lines>
        <reason>The course content management page needs to display the list of documents and provide UI for deletion.</reason>
      </artifact>
      <artifact>
        <path>src/app/_components/teacher/DocumentList.tsx</path>
        <kind>ui-component</kind>
        <symbol>DocumentListComponent</symbol>
        <lines>N/A (New file)</lines>
        <reason>A new UI component to display the list of uploaded documents and handle delete actions, including confirmation.</reason>
      </artifact>
      <artifact>
        <path>src/server/services/supabase.ts</path>
        <kind>service</kind>
        <symbol>SupabaseService</symbol>
        <lines>Relevant methods (listObjects, deleteObject)</lines>
        <reason>Modification to the Supabase service to include methods for listing and deleting files in Storage.</reason>
      </artifact>
      <artifact>
        <path>src/server/services/pinecone.ts</path>
        <kind>service</kind>
        <symbol>PineconeClient</symbol>
        <lines>Relevant methods (deleteMany)</lines>
        <reason>Modification to the Pinecone service to include methods for deleting embeddings when a document is removed.</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency ecosystem="node">
        <name>next</name>
        <version>^15.2.3</version>
        <reason>Core application framework.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>react</name>
        <version>^19.0.0</version>
        <reason>UI library for building components.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>next-auth</name>
        <version>5.0.0-beta.25</version>
        <reason>Authentication library for Next.js.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>@prisma/client</name>
        <version>^6.6.0</version>
        <reason>O/RM for database interaction.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>@trpc/server</name>
        <version>^11.0.0</version>
        <reason>Framework for creating type-safe APIs.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>zod</name>
        <version>^3.24.2</version>
        <reason>Schema validation library for tRPC inputs.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>google-gemini-generative-ai</name>
        <version>~0.0.0</version>
        <reason>Client library for interacting with the Google Gemini Large Language Model.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>zustand</name>
        <version>~0.0.0</version>
        <reason>Client-side state management library for conversation history.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>react-email</name>
        <version>~0.0.0</version>
        <reason>Library for creating email templates using React components.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>cld3-wasm</name>
        <version>~0.0.0</version>
        <reason>Potential library for client-side language detection.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>pdf-parse</name>
        <version>~0.0.0</version>
        <reason>Library for parsing PDF documents.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>mammoth</name>
        <version>~0.0.0</version>
        <reason>Library for parsing DOCX documents.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>openai</name>
        <version>~0.0.0</version>
        <reason>Client library for interacting with OpenAI (or similar) embedding models.</reason>
      </dependency>
      <dependency ecosystem="node">
        <name>@supabase/supabase-js</name>
        <version>^2.x.x</version>
        <reason>Client library for interacting with Supabase services, including Storage.</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>When a document is deleted from Supabase Storage, its corresponding embeddings must also be removed from the Pinecone index to maintain data consistency and prevent stale data.</constraint>
    <constraint>The tRPC procedures for listing and deleting documents must be protected to ensure only the assigned teacher has access to manage their course's content.</constraint>
    <constraint>The UI for deleting documents must include a confirmation dialog to prevent accidental data loss.</constraint>
    <constraint>Uploading a new document with the same name as an existing one should automatically replace the old version in Supabase Storage and trigger its re-indexing in Pinecone.</constraint>
    <constraint>Consider implementing soft deletes for documents in the future for more robust data recovery, though this is out of scope for basic versioning.</constraint>
  </constraints>
  <interfaces>
    <interface>
      <name>List Documents tRPC Procedure</name>
      <kind>tRPC-procedure</kind>
      <signature>
        listDocuments: teacherProcedure
          .input(z.object({
            courseId: z.string(),
          }))
          .query(async ({ ctx, input }) => {
            return Array<{ name: string; url: string; size: number; }>; // List of document metadata
          });
      </signature>
      <path>src/server/api/routers/teacher.ts</path>
      <reason>API for fetching a list of uploaded documents for a specific course.</reason>
    </interface>
    <interface>
      <name>Delete Document tRPC Procedure</name>
      <kind>tRPC-procedure</kind>
      <signature>
        deleteDocument: teacherProcedure
          .input(z.object({
            courseId: z.string(),
            filePath: z.string(), // Path in Supabase Storage
          }))
          .mutation(async ({ ctx, input }) => {
            return { success: boolean; };
          });
      </signature>
      <path>src/server/api/routers/teacher.ts</path>
      <reason>API for securely deleting a specific document from storage and its embeddings.</reason>
    </interface>
    <interface>
      <name>Supabase Storage Service (Modified)</name>
      <kind>External Service Client</kind>
      <signature>
        class SupabaseStorageService {
          // ... existing methods
          listObjects(bucket: string, path?: string, options?: object): Promise<{ name: string; id: string; }[]>;
          removeObjects(bucket: string, paths: string[]): Promise<any>;
        }
      </signature>
      <path>src/server/services/supabase.ts</path>
      <reason>Modification to include methods for listing and deleting objects in Supabase Storage.</reason>
    </interface>
    <interface>
      <name>Pinecone Client (Modified)</name>
      <kind>External Service Client</kind>
      <signature>
        class PineconeClient {
          // ... existing methods
          deleteMany(ids: string[], namespace?: string): Promise<void>; // Delete embeddings by ID
        }
      </signature>
      <path>src/server/services/pinecone.ts</path>
      <reason>Modification to include methods for deleting embeddings from Pinecone when a document is removed.</reason>
    </interface>
  </interfaces>
  <tests>
    <standards>
      A pragmatic testing approach will be used.
      - **Unit Tests:** Jest and React Testing Library will be used for unit testing critical UI components and business logic.
      - **Integration Tests:** Integration tests will be written for tRPC API procedures to ensure they interact with the database correctly.
    </standards>
    <locations>
      Test files should be co-located with the source files they are testing (e.g., `MyComponent.tsx` and `MyComponent.test.tsx` in the same folder).
    </locations>
    <ideas>
      <idea for="AC1">Write an integration test for the `listDocuments` tRPC procedure, verifying that it correctly retrieves and returns a list of document metadata (name, URL, size) for a specified course from Supabase Storage.</idea>
      <idea for="AC2">Write an integration test for the `deleteDocument` tRPC procedure, ensuring that it successfully removes the target document from Supabase Storage and its corresponding embeddings from Pinecone, and handles error cases (e.g., document not found).</idea>
      <idea for="AC3">Perform an end-to-end test of the document replacement functionality: upload a new version of an existing document via the UI, and then verify that the old version is correctly replaced and the updated document's content is reflected in the chatbot's knowledge base (via Pinecone).</idea>
      <idea for="UI">Write a unit test for the `DocumentListComponent` to verify that it correctly displays the list of documents, provides functional delete buttons, and presents a confirmation dialog before deletion.</idea>
    </ideas>
  </tests>
</story-context>
